<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Chatbot</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121833;
      --muted: #9aa4c7;
      --text: #e8ecff;
      --accent: #6aa2ff;
      --accent-2: #8b5cf6;
      --danger: #ff6b6b;
      --ring: 0 0 0 3px rgba(106, 162, 255, .25);
    }
    .light {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --danger: #e11d48;
      --ring: 0 0 0 3px rgba(37, 99, 235, .18);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .app {
      max-width: 920px; margin: 0 auto; height: 100vh; display: grid;
      grid-template-rows: auto 1fr auto; gap: 14px; padding: 16px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--panel); border: 1px solid rgba(255,255,255,.06);
      padding: 12px 14px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.18);
    }
    header .title { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    header .badge { font-weight: 600; font-size: 12px; color: var(--muted); }
    .btn {
      border: 1px solid rgba(255,255,255,.12); background: transparent; color: var(--text);
      padding: 8px 12px; border-radius: 12px; cursor: pointer; transition: .15s ease;
    }
    .btn:hover { transform: translateY(-1px); border-color: rgba(255,255,255,.25); }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; color: #fff; }
    .btn.danger { border-color: transparent; background: linear-gradient(135deg, var(--danger), #ff9aa2); color: #fff; }

    .chat {
      background: var(--panel); border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 12px; overflow: hidden; display: grid;
      grid-template-rows: 1fr auto; height: 100%;
    }

    .messages {
      overflow-y: auto; padding: 6px; display: flex; flex-direction: column; gap: 10px;
      scroll-behavior: smooth;
    }
    .bubble {
      max-width: 78%; padding: 10px 12px; border-radius: 14px; position: relative;
      border: 1px solid rgba(255,255,255,.06);
    }
    .bubble.user { align-self: flex-end; background: rgba(106, 162, 255, .15); border-color: rgba(106,162,255,.35); }
    .bubble.bot { align-self: flex-start; background: rgba(255,255,255,.03); }
    .meta { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .composer {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; padding: 10px;
      background: linear-gradient(0deg, rgba(255,255,255,.03), transparent);
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .input {
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.1);
      border-radius: 14px; padding: 10px 12px; color: var(--text); outline: none; resize: vertical; min-height: 44px; max-height: 40vh;
    }
    .input:focus { box-shadow: var(--ring); }

    .row { display: flex; gap: 8px; align-items: center; }
    .toolbar { display: flex; gap: 8px; }

    .typing { display: inline-flex; gap: 4px; align-items: center; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); opacity: .6; animation: blink 1s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes blink { 0%, 80%, 100% { opacity: .2 } 40% { opacity: 1 } }

    .footer { display: flex; justify-content: space-between; align-items: center; color: var(--muted); font-size: 12px; padding: 0 6px 6px; }
    .link { color: var(--accent); text-decoration: none; }
    .link:hover { text-decoration: underline; }

    @media (max-width: 640px) { .bubble { max-width: 90%; } }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2a7 7 0 0 0-7 7v2.5A3.5 3.5 0 0 0 3.5 15 3.5 3.5 0 0 0 7 18.5h2.586l2.707 2.707A1 1 0 0 0 14 20.5v-2h3A3.5 3.5 0 0 0 20.5 15 3.5 3.5 0 0 0 17 11.5V9a7 7 0 0 0-7-7z" fill="currentColor"/>
        </svg>
        <span>Medical Chatbot</span>
        <span class="badge">demo</span>
      </div>
      <div class="toolbar">
        <button class="btn" id="themeBtn" title="Toggle light/dark">Theme</button>
        <button class="btn" id="clearBtn" title="Clear chat">New Chat</button>
        <button class="btn primary" id="exportBtn" title="Export chat">Export</button>
      </div>
    </header>

    <section class="chat">
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" class="input" placeholder="Ask a medical question... (Shift+Enter for newline)"></textarea>
        <div class="row">
          <button class="btn" id="stopBtn" style="display:none">Stop</button>
          <button class="btn primary" id="sendBtn">Send â–¸</button>
        </div>
      </div>
    </section>

    <div class="footer">
      <div>Educational use only. Not a substitute for professional medical advice.</div>
      <a class="link" href="#" id="howLink">How it works</a>
    </div>
  </div>

  <script>
    const el = (tag, cls, text) => { const n = document.createElement(tag); if (cls) n.className = cls; if (text) n.textContent = text; return n; };
    const $msgs = document.getElementById('messages');
    const $input = document.getElementById('input');
    const $send = document.getElementById('sendBtn');
    const $stop = document.getElementById('stopBtn');
    const $clear = document.getElementById('clearBtn');
    const $export = document.getElementById('exportBtn');
    const $theme = document.getElementById('themeBtn');

    let controller = null; // AbortController for streaming/stop

    const state = {
      history: JSON.parse(localStorage.getItem('chat-history') || '[]'),
      theme: localStorage.getItem('theme') || 'dark'
    };

    if (state.theme === 'light') document.body.classList.add('light');

    function save() { localStorage.setItem('chat-history', JSON.stringify(state.history)); }

    function addBubble(role, text) {
      const wrap = el('div', `bubble ${role}`);
      wrap.append(text instanceof Node ? text : document.createTextNode(text));
      $msgs.appendChild(wrap);
      $msgs.scrollTop = $msgs.scrollHeight;
    }

    function addTyping() {
      const wrap = el('div', 'bubble bot');
      const typing = el('span', 'typing');
      typing.append(el('span', 'dot'), el('span', 'dot'), el('span', 'dot'));
      wrap.appendChild(typing);
      $msgs.appendChild(wrap);
      $msgs.scrollTop = $msgs.scrollHeight;
      return wrap; // return element so we can replace it later
    }

    function renderHistory() {
      $msgs.innerHTML = '';
      for (const m of state.history) addBubble(m.role, m.content);
      if (state.history.length === 0) {
        const tip = el('div', 'bubble bot');
        tip.innerHTML = '<strong>Hi!</strong> I\'m a medical information bot. Ask me about symptoms, conditions, or medicines. I cannot diagnose.';
        $msgs.appendChild(tip);
      }
      $msgs.scrollTop = $msgs.scrollHeight;
    }

    async function sendMessage() {
      const text = $input.value.trim();
      if (!text) return;
      $input.value = '';
      addBubble('user', text);
      state.history.push({ role: 'user', content: text });
      save();

      const typingEl = addTyping();
      $send.disabled = true; $stop.style.display = 'inline-block';

      try {
        controller = new AbortController();
        // ðŸ”Œ Change this URL to your backend route
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            history: state.history.slice(-10) // send last 10 turns
          }),
          signal: controller.signal
        });
        if (!res.ok) throw new Error('Network error: ' + res.status);
        const data = await res.json();
        typingEl.remove();
        const botText = data.reply || 'Sorry, I could not generate a response.';
        addBubble('bot', botText);
        state.history.push({ role: 'assistant', content: botText });
        save();
      } catch (err) {
        typingEl.remove();
        console.error(err);
        addBubble('bot', 'âš ï¸ Error: ' + (err.message || 'request failed'));
      } finally {
        controller = null; $send.disabled = false; $stop.style.display = 'none';
      }
    }

    // Optional: basic streaming via EventSource (SSE) could be wired here.

    $send.addEventListener('click', sendMessage);
    $input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    $stop.addEventListener('click', () => { if (controller) controller.abort(); });
    $clear.addEventListener('click', () => { state.history = []; save(); renderHistory(); });
    $export.addEventListener('click', () => {
      const lines = state.history.map(m => (m.role === 'user' ? 'You: ' : 'Bot: ') + m.content);
      const blob = new Blob([lines.join('\n\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = el('a'); a.href = url; a.download = 'medical-chat-export.txt'; a.click(); URL.revokeObjectURL(url);
    });
    $theme.addEventListener('click', () => {
      document.body.classList.toggle('light');
      state.theme = document.body.classList.contains('light') ? 'light' : 'dark';
      localStorage.setItem('theme', state.theme);
    });

    document.getElementById('howLink').addEventListener('click', (e) => {
      e.preventDefault();
      const msg = `This is a frontend-only template. Hook up POST /api/chat on your server to return { reply: string } based on your LLM.\n\nSample FastAPI route (Python):\n\nfrom fastapi import FastAPI\nfrom pydantic import BaseModel\nfrom fastapi.middleware.cors import CORSMiddleware\napp = FastAPI()\napp.add_middleware(CORSMiddleware, allow_origins=['*'], allow_methods=['*'], allow_headers=['*'])\nclass Body(BaseModel):\n    message: str\n    history: list\n@app.post('/api/chat')\nasync def chat(b: Body):\n    # TODO: call your LLM, RAG, etc.\n    return { 'reply': 'This is a demo response. Replace with your backend.' }`;
      alert(msg);
    });

    renderHistory();
  </script>
</body>
</html>
